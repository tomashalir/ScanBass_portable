<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ScanBass Studio ‚Ä¢ Hyperglass</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            display: ['Space Grotesk', 'system-ui', 'sans-serif']
          }
        }
      }
    };
  </script>
  <style>
    :root {
      --bg: radial-gradient(circle at 14% 18%, rgba(0, 255, 191, 0.18), rgba(3, 4, 10, 0.65) 42%),
             radial-gradient(circle at 82% 12%, rgba(0, 157, 255, 0.15), transparent 46%),
             radial-gradient(circle at 50% 92%, rgba(106, 29, 255, 0.24), transparent 60%),
             #03040a;
      color-scheme: dark;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      background-attachment: fixed;
      color: #f4f8ff;
    }

    .nebula {
      position: fixed;
      inset: -20vh -20vw;
      pointer-events: none;
      background: radial-gradient(circle at 20% 32%, rgba(0, 225, 255, 0.24), transparent 55%),
                  radial-gradient(circle at 80% 18%, rgba(255, 84, 251, 0.18), transparent 55%),
                  radial-gradient(circle at 46% 86%, rgba(45, 0, 255, 0.22), transparent 65%);
      filter: blur(120px);
      opacity: 0.85;
      transform: scale(1.1);
      animation: drift 16s ease-in-out infinite alternate;
      z-index: 0;
    }

    .constellation {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(rgba(255, 255, 255, 0.12) 1px, transparent 1px);
      background-size: 120px 120px;
      opacity: 0.25;
      mask-image: radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.72), transparent 78%);
      z-index: 0;
    }

    .glass-panel {
      position: relative;
      overflow: hidden;
      border-radius: 28px;
      background: rgba(8, 10, 18, 0.68);
      border: 1px solid rgba(169, 212, 255, 0.08);
      backdrop-filter: blur(28px);
      box-shadow: 0 28px 80px rgba(6, 14, 32, 0.55);
      transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1),
                  box-shadow 0.6s cubic-bezier(0.16, 1, 0.3, 1),
                  border-color 0.4s ease;
      isolation: isolate;
    }

    .glass-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.1), transparent 40%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .glass-panel::after {
      content: '';
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.05);
      pointer-events: none;
    }

    .glass-panel:hover,
    .glass-panel:focus-within {
      transform: translateY(-6px);
      box-shadow: 0 38px 120px rgba(14, 40, 88, 0.65);
      border-color: rgba(0, 209, 255, 0.28);
    }

    /* === breathing orb ‚Äì vrstven√° verze === */
    .hero-orb {
      position: relative;
      width: clamp(200px, 28vw, 280px);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      overflow: visible;
      filter: drop-shadow(0 0 55px rgba(56, 189, 248, 0.35));
    }

    .hero-orb .orb-layer {
      position: absolute;
      inset: 0;
      border-radius: 9999px;
      animation: breathe 7s ease-in-out infinite;
    }

    .hero-orb .orb-outer {
      background: radial-gradient(circle, rgba(59, 130, 246, 0.18), rgba(17, 24, 39, 0));
      animation-delay: 0s;
    }

    .hero-orb .orb-middle {
      inset: 12%;
      background: radial-gradient(circle, rgba(94, 234, 212, 0.35), rgba(15, 23, 42, 0));
      animation-delay: 0.3s;
    }

    .hero-orb .orb-inner {
      inset: 24%;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.75), rgba(15, 23, 42, 0));
      animation-delay: 0.6s;
      box-shadow: inset 0 0 25px rgba(248, 250, 255, 0.18);
    }

    @media (max-width: 640px) {
      .hero-orb {
        width: clamp(160px, 55vw, 220px);
        margin: 0 auto;
      }
    }

    #dropzone {
      border-radius: 22px;
      border: 1.6px dashed rgba(190, 214, 255, 0.48);
      background: rgba(3, 6, 16, 0.45);
      transition: border-color 0.35s ease, background 0.35s ease, transform 0.45s cubic-bezier(0.16, 1, 0.3, 1);
      cursor: pointer;
    }

    #dropzone:hover,
    #dropzone:focus-visible,
    #dropzone.active {
      border-color: rgba(0, 209, 255, 0.88);
      background: radial-gradient(circle at top, rgba(0, 209, 255, 0.18), rgba(3, 6, 16, 0.5));
      transform: translateY(-2px);
    }

    #dropzone input {
      display: none;
    }

    .variant-btn {
      border-radius: 999px;
      border: 1px solid rgba(0, 209, 255, 0.3);
      background: rgba(255, 255, 255, 0.04);
      color: #e0f2fe;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      padding: 0.35rem 0.95rem;
      text-transform: uppercase;
      transition: all 0.25s ease;
    }

    .variant-btn:hover {
      background: rgba(0, 209, 255, 0.1);
      transform: translateY(-1px);
    }

    .variant-btn.active {
      background: linear-gradient(120deg, rgba(14, 165, 233, 0.35), rgba(236, 72, 153, 0.32));
      border-color: rgba(236, 72, 153, 0.35);
      color: #0b1224;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(45, 188, 255, 0.22);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.5rem;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 999px;
      background: rgba(0, 209, 255, 0.18);
      border: 1px solid rgba(0, 209, 255, 0.35);
      font-size: 0.75rem;
      line-height: 1;
    }

    .loader {
      display: flex;
      gap: 0.9rem;
      align-items: center;
      border-radius: 16px;
      background: rgba(2, 6, 18, 0.45);
      border: 1px solid rgba(180, 220, 255, 0.08);
      padding: 0.75rem 1rem;
    }

    .orbital {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid rgba(0, 209, 255, 0.35);
      border-top-color: rgba(0, 209, 255, 1);
      animation: spin 0.75s linear infinite;
    }

    .download-card {
      border-radius: 20px;
      background: rgba(5, 10, 22, 0.6);
      border: 1px solid rgba(148, 194, 255, 0.14);
      padding: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .download-card h3 {
      margin: 0;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .artifact-list {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      padding: 0;
      margin: 0;
      list-style: none;
    }

    .artifact-list li {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.75rem;
      color: rgba(214, 234, 255, 0.72);
    }

    .artifact-list code {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      letter-spacing: 0.02em;
      color: rgba(233, 245, 255, 0.86);
    }

    @keyframes drift {
      from {
        transform: scale(1.05) translate3d(-12px, -10px, 0);
      }
      to {
        transform: scale(1.12) translate3d(14px, 12px, 0);
      }
    }

    /* jemn√Ω dech + hue shift */
    @keyframes breathe {
      0%, 100% {
        transform: scale(0.95);
        filter: hue-rotate(0deg);
      }
      50% {
        transform: scale(1.05);
        filter: hue-rotate(15deg);
      }
    }

    @keyframes orbit {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body class="relative min-h-screen overflow-x-hidden bg-transparent text-slate-100 antialiased">
  <div class="nebula"></div>
  <div class="constellation"></div>

  <main class="relative z-10 mx-auto flex w-full max-w-6xl flex-col gap-16 px-6 pb-24 pt-12 sm:px-10 lg:px-16">
    <div class="inline-flex items-center gap-2 self-start rounded-full border border-white/10 bg-white/5 px-4 py-1 text-[0.65rem] uppercase tracking-[0.28em] text-slate-200/75">
      <span class="h-2.5 w-2.5 rounded-full bg-gradient-to-br from-cyan-300 via-sky-400 to-fuchsia-500"></span>
      Scanbass Studio
    </div>
    <div class="grid gap-6 lg:grid-cols-3">
      <section class="glass-panel group flex flex-col gap-6 p-6 sm:p-8">
        <h2 class="flex items-center gap-3 text-xs font-semibold uppercase tracking-[0.28em] text-slate-100/85">
          <span class="flex h-9 w-9 items-center justify-center rounded-full border border-cyan-300/35 bg-cyan-400/15 text-sm font-semibold text-cyan-100">1</span>
          Drop your loop
        </h2>
        <p class="text-sm leading-relaxed text-slate-200/80">
          Drag in a hook, loop, or bass idea ‚Äî we automatically trim to 30 seconds and normalize for Render-friendly CPU use.
        </p>
        <form id="uploadForm" class="flex flex-col gap-4">
          <label id="dropzone" for="fileInput" class="flex flex-col gap-3 p-5 text-sm text-slate-100/85 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-300/60">
            <input type="file" id="fileInput" accept=".wav,.mp3,.flac,.ogg,.mid,.midi" />
            <div id="dropLabel" class="flex items-center gap-3 text-base text-slate-100/90">
              <span class="text-xl">üéµ</span>
              <span>Drag &amp; drop or click to upload</span>
            </div>
            <small class="pl-9 text-xs leading-relaxed text-slate-300/70">Only the first 30 seconds are processed. We create a local 44.1&nbsp;kHz PCM16 clip to keep scanning accurate and CPU-friendly.</small>
          </label>

          <div class="flex flex-col gap-2 rounded-2xl border border-white/5 bg-white/5/50 p-4 text-xs text-slate-200/75">
            <strong class="text-[0.68rem] font-semibold uppercase tracking-[0.3em] text-slate-100/85">Poly mode</strong>
            <span>We pick the lowest melodic line from your audio / MIDI.</span>
            <span>Outputs a single bassline as standard MIDI.</span>
            <span>Uploads longer than 30 s are automatically truncated after preparation.</span>
          </div>

          <button type="submit" id="processBtn" class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-cyan-300 via-sky-400 to-fuchsia-500 px-6 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-slate-900 shadow-[0_16px_40px_rgba(34,211,238,0.35)] transition-transform duration-500 hover:-translate-y-0.5 hover:shadow-[0_24px_70px_rgba(34,211,238,0.45)] disabled:cursor-not-allowed disabled:opacity-60">
            Render MIDI
          </button>
        </form>
      </section>

      <section class="glass-panel flex flex-col gap-6 p-6 sm:p-8">
        <h2 class="flex items-center gap-3 text-xs font-semibold uppercase tracking-[0.28em] text-slate-100/85">
          <span class="flex h-9 w-9 items-center justify-center rounded-full border border-cyan-300/35 bg-cyan-400/15 text-sm font-semibold text-cyan-100">2</span>
          See the progress
        </h2>
        <p class="text-sm leading-relaxed text-slate-200/80">
          Once uploaded we trim, resample, and transcribe the lowest notes. Status updates land here while the job stays queued or running.
        </p>
        <div id="loader" class="loader hidden" role="status" aria-live="polite">
          <div class="orbital"></div>
          <p id="loaderText" class="text-sm text-slate-200/80">Preparing upload‚Ä¶</p>
        </div>
        <div id="status" class="rounded-2xl border border-white/5 bg-white/5/50 p-4 text-sm leading-relaxed text-slate-200/85" aria-live="polite">
          Waiting for your upload.
        </div>
      </section>

      <section class="glass-panel flex flex-col gap-6 p-6 sm:p-8">
        <h2 class="flex items-center gap-3 text-xs font-semibold uppercase tracking-[0.28em] text-slate-100/85">
          <span class="flex h-9 w-9 items-center justify-center rounded-full border border-cyan-300/35 bg-cyan-400/15 text-sm font-semibold text-cyan-100">3</span>
          Download the bassline / MIDI
        </h2>
        <p class="text-sm leading-relaxed text-slate-200/80">
          When we finish packaging, grab the bassline or full melody MIDI along with any extra artifacts generated from the scan.
        </p>
        <p id="downloadHint" class="text-xs uppercase tracking-[0.24em] text-slate-300/65">Results will unlock here once the transcription completes.</p>
        <div id="downloadCard" class="download-card hidden">
          <h3>MIDI ready</h3>
          <div class="flex flex-wrap items-center gap-2 pt-1" id="variantSwitcher">
            <button data-variant="bassline" class="variant-btn active">Bassline MIDI</button>
            <button data-variant="full" class="variant-btn">Full melody MIDI</button>
          </div>
          <div id="midiDownload" class="text-sm text-cyan-200"></div>
          <ul id="artifactList" class="artifact-list hidden" aria-live="polite"></ul>
        </div>
      </section>
    </div>

    <section class="glass-panel px-6 py-12 sm:px-10 lg:px-14">
      <div class="flex min-h-[75vh] flex-col items-center justify-center gap-12 text-center lg:min-h-[80vh] lg:grid lg:grid-cols-[1.1fr_0.9fr] lg:items-center lg:text-left">
        <div class="flex w-full flex-col items-center gap-8 lg:items-start">
          <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-1 text-[0.65rem] uppercase tracking-[0.28em] text-slate-200/75">
            <span class="h-2.5 w-2.5 rounded-full bg-gradient-to-br from-cyan-300 via-sky-400 to-fuchsia-500"></span>
            ScanBass Studio
          </div>
          <div class="flex w-full flex-col gap-4 lg:max-w-xl">
            <h1 class="font-display text-4xl leading-tight tracking-tight text-white sm:text-5xl">Basslines and full MIDI in three steps.</h1>
            <p class="text-base leading-relaxed text-slate-200/85 sm:text-lg">
              Drop in your 30-second idea, watch us isolate the lowest line, and download either the finished bassline MIDI or the full transcription to keep building fast.
            </p>
          </div>
          <!-- nov√© value bullets -->
          <ul class="w-full max-w-xl space-y-3 text-left text-sm text-slate-200/80">
            <li class="flex items-start gap-3 leading-relaxed">
              <span class="mt-1.5 h-2.5 w-2.5 shrink-0 rounded-full bg-cyan-300/80 shadow-[0_0_10px_rgba(34,211,238,0.6)]"></span>
              <span>Instantly turn your melody into a perfect bassline.</span>
            </li>
            <li class="flex items-start gap-3 leading-relaxed">
              <span class="mt-1.5 h-2.5 w-2.5 shrink-0 rounded-full bg-cyan-300/80 shadow-[0_0_10px_rgba(34,211,238,0.6)]"></span>
              <span>Download DAW-ready bassline MIDI or the full melody MIDI, whichever keeps you moving.</span>
            </li>
            <li class="flex items-start gap-3 leading-relaxed">
              <span class="mt-1.5 h-2.5 w-2.5 shrink-0 rounded-full bg-cyan-300/80 shadow-[0_0_10px_rgba(34,211,238,0.6)]"></span>
              <span>Spend less time tweaking, more time creating.</span>
            </li>
          </ul>
          <div class="mt-6 flex w-full flex-col gap-3 text-left text-[0.7rem] uppercase tracking-[0.22em] text-slate-300/70 sm:flex-row sm:flex-wrap sm:items-center sm:justify-between">
            <span>Tip: Bounce your hook or intro ‚Äî only the first 30 seconds are analyzed.</span>
            <span>Uploads convert into a 44.1&nbsp;kHz PCM16 clip for accurate scanning.</span>
          </div>
        </div>
        <div class="flex w-full items-center justify-center">
          <!-- breathing orb -->
          <div class="hero-orb">
            <div class="orb-layer orb-outer"></div>
            <div class="orb-layer orb-middle"></div>
            <div class="orb-layer orb-inner"></div>
          </div>
        </div>
      </div>
    </section>
  </main>


  <script>
  const API_BASE = "https://scanbass-backend.onrender.com";
  const LIMIT_SECONDS = 30;
  const form = document.getElementById("uploadForm");
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("fileInput");
  const processBtn = document.getElementById("processBtn");
  const loader = document.getElementById("loader");
  const loaderText = document.getElementById("loaderText");
  const statusDiv = document.getElementById("status");
  const downloadCard = document.getElementById("downloadCard");
  const midiDownload = document.getElementById("midiDownload");
  const artifactList = document.getElementById("artifactList");
  const downloadHint = document.getElementById("downloadHint");
  const variantSwitcher = document.getElementById("variantSwitcher");
  let currentDownloadUrl = null;
  let lastUploadedName = null;
  let currentPollAbort = null;
  let availableDownloads = {};
  let selectedVariant = "bassline";
  let lastJobId = null;

  const statusBadge = document.createElement("span");
  statusBadge.className = "badge";

  function setStatus(message, badge = "") {
    statusDiv.textContent = "";
    if (!message) return;

    if (badge) {
      statusBadge.textContent = badge;
      const clone = statusBadge.cloneNode(true);
      statusDiv.appendChild(clone);
    }
    statusDiv.append(message);
  }

  function updateLoaderMessage(message) {
    if (message) {
      loaderText.textContent = message;
    }
  }

  function showLoader(message) {
    updateLoaderMessage(message);
    loader.classList.remove("hidden");
  }

  function hideLoader() {
    loader.classList.add("hidden");
  }

  function resetDownloadCard() {
    if (currentDownloadUrl) {
      URL.revokeObjectURL(currentDownloadUrl);
      currentDownloadUrl = null;
    }
    midiDownload.innerHTML = "";
    downloadCard.classList.add("hidden");
    artifactList.innerHTML = "";
    artifactList.classList.add("hidden");
    downloadHint?.classList.remove("hidden");
    availableDownloads = {};
    selectedVariant = "bassline";
    variantSwitcher?.querySelectorAll(".variant-btn").forEach(btn => btn.classList.remove("active"));
    variantSwitcher?.querySelector('[data-variant="bassline"]')?.classList.add("active");
  }

  function describeDownload(name, variantKey = "bassline") {
    if ((name || "").toLowerCase().endsWith(".zip")) {
      return "ZIP includes trimmed clip, isolated bass, and MIDI";
    }
    return variantKey === "full" ? "Full transcription MIDI" : "DAW-ready bassline MIDI";
  }

  function renderArtifacts(artifacts) {
    // nov√Ω backend teƒè artefakty nepos√≠l√° ‚Äì prostƒõ to skryjeme
    artifactList.innerHTML = "";
    artifactList.classList.add("hidden");
  }

  function setActiveVariantButton(variant) {
    selectedVariant = variant;
    variantSwitcher?.querySelectorAll(".variant-btn").forEach(btn => {
      const isActive = btn.dataset.variant === variant;
      btn.classList.toggle("active", isActive);
      btn.ariaPressed = isActive;
    });
  }

  function getVariantInfo(preferred) {
    if (preferred && availableDownloads[preferred]) {
      return { key: preferred, ...availableDownloads[preferred] };
    }
    if (availableDownloads[selectedVariant]) {
      return { key: selectedVariant, ...availableDownloads[selectedVariant] };
    }
    const firstKey = Object.keys(availableDownloads)[0];
    if (firstKey) {
      return { key: firstKey, ...availableDownloads[firstKey] };
    }
    return null;
  }

  function prepareDownloads(job) {
    availableDownloads = job?.downloads || {};
    if (!Object.keys(availableDownloads).length && job?.download_url) {
      availableDownloads = {
        bassline: { url: job.download_url, name: fallbackDownloadName(job.job_id, lastUploadedName), label: "Bassline MIDI" },
      };
    }

    const hasFull = Boolean(availableDownloads.full);
    setActiveVariantButton(hasFull ? selectedVariant : "bassline");
    downloadHint?.classList.add("hidden");
    downloadCard.classList.remove("hidden");
  }

  function showDownload(blob, downloadName, artifacts, variantKey = selectedVariant) {
    if (currentDownloadUrl) {
      URL.revokeObjectURL(currentDownloadUrl);
    }
    const url = URL.createObjectURL(blob);
    currentDownloadUrl = url;
    const name = downloadName || "scanbass.mid";
    const label = availableDownloads[variantKey]?.label || (variantKey === "full" ? "Full melody MIDI" : "Bassline MIDI");
    midiDownload.innerHTML = `
      <a class="inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-cyan-200 transition hover:bg-white/15"
         href="${url}" download="${name}" draggable="true">
        ‚¨áÔ∏è Download ${label}
      </a>
      <span class="block pt-2 text-[0.7rem] text-slate-300/75">${describeDownload(name, variantKey)}</span>
    `;
    downloadHint?.classList.add("hidden");
    downloadCard.classList.remove("hidden");
    renderArtifacts(artifacts);
  }

  async function downloadSelectedVariant(jobId, preferredVariant) {
    const info = getVariantInfo(preferredVariant);
    if (!info) {
      throw new Error("No download available yet");
    }

    const resp = await fetch(`${API_BASE}${info.url}`);
    if (!resp.ok) {
      throw new Error(`Download failed (${resp.status})`);
    }

    const blob = await resp.blob();
    const resolvedName = extractFileName(resp, jobId, lastUploadedName) || info.name;
    showDownload(blob, resolvedName, null, info.key);
    setStatus(`${info.label || "MIDI"} ready to download.`, "‚¨áÔ∏è");
  }

  function fallbackDownloadName(jobId, originalName) {
    if (originalName) {
      const dot = originalName.lastIndexOf(".");
      const base = dot > -1 ? originalName.slice(0, dot) : originalName;
      return `${base || "scanbass"}.mid`;
    }
    return `scanbass-${jobId}.mid`;
  }

  function extractFileName(response, jobId, originalName) {
    const header = response.headers.get("Content-Disposition") || "";
    let match = header.match(/filename\*=UTF-8''([^;\s]+)/i);
    if (match && match[1]) {
      try {
        return decodeURIComponent(match[1]);
      } catch {
        return match[1];
      }
    }
    match = header.match(/filename="?([^";]+)"?/i);
    if (match && match[1]) {
      return match[1];
    }
    return fallbackDownloadName(jobId, originalName);
  }

  function delay(ms, signal) {
    return new Promise((resolve, reject) => {
      const t = setTimeout(() => {
        signal?.removeEventListener("abort", onAbort);
        resolve();
      }, ms);

      function onAbort() {
        clearTimeout(t);
        reject(new DOMException("Aborted", "AbortError"));
      }

      if (signal) {
        if (signal.aborted) {
          onAbort();
          return;
        }
        signal.addEventListener("abort", onAbort, { once: true });
      }
    }).catch(err => {
      if (err.name === "AbortError") return;
      throw err;
    });
  }

  async function pollJob(jobId) {
    cancelPolling();
    const abort = new AbortController();
    currentPollAbort = abort;

    try {
      while (!abort.signal.aborted) {
        const resp = await fetch(`${API_BASE}/jobs/${encodeURIComponent(jobId)}`, {
          headers: { Accept: "application/json" },
          signal: abort.signal,
        });

        if (!resp.ok) {
          throw new Error(`Status ${resp.status}`);
        }

        // NOV√â: backend V≈ΩDY vrac√≠ JSON
        const job = await resp.json();

        // 1) po≈ô√°d zpracov√°v√°
        if (job.status === "processing") {
          showLoader(`Processing ${LIMIT_SECONDS} s clip‚Ä¶`);
          setStatus("Transcribing bassline‚Ä¶", "‚óè");
          await delay(1500, abort.signal);
          continue;
        }

        // 2) chyba
        if (job.status === "error") {
          hideLoader();
          setStatus(`Error: ${job.error || "unknown error"}`, "‚úñ");
          processBtn.disabled = false;
          break;
        }

        // 3) hotovo
        if (job.status === "done") {
          lastJobId = jobId;
          await finalizeJob(job);
          break;
        }

        // fallback
        setStatus(`Status: ${job.status}`, "‚ÑπÔ∏è");
        await delay(1500, abort.signal);
      }
    } catch (err) {
      if (abort.signal.aborted) return;
      console.error(err);
      hideLoader();
      setStatus(`Error while polling job: ${err.message}`, "!");
      processBtn.disabled = false;
    } finally {
      if (currentPollAbort === abort) {
        currentPollAbort = null;
      }
    }
  }

  async function finalizeJob(job) {
    showLoader("Packaging bassline and MIDI‚Ä¶");
    setStatus("Packaging outputs‚Ä¶", "‚¨áÔ∏è");

    prepareDownloads(job);

    try {
      await downloadSelectedVariant(job.job_id, selectedVariant);
    } catch (err) {
      console.error(err);
      setStatus(`Could not download results: ${err.message}`, "!");
    } finally {
      hideLoader();
      processBtn.disabled = false;
    }
  }

  // drag & drop
  ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
    dropzone.addEventListener(eventName, event => {
      event.preventDefault();
      event.stopPropagation();
    });
  });

  ["dragenter", "dragover"].forEach(eventName => {
    dropzone.addEventListener(eventName, () => dropzone.classList.add("active"));
  });

  ["dragleave", "drop"].forEach(eventName => {
    dropzone.addEventListener(eventName, () => dropzone.classList.remove("active"));
  });

  dropzone.addEventListener("drop", event => {
    const file = event.dataTransfer?.files?.[0];
    if (file) {
      fileInput.files = event.dataTransfer.files;
      lastUploadedName = file.name;
      updateDropLabel(file.name);
    }
  });

  fileInput.addEventListener("change", () => {
    if (fileInput.files.length > 0) {
      const name = fileInput.files[0].name;
      lastUploadedName = name;
      updateDropLabel(name);
    }
  });

  function updateDropLabel(filename) {
    const label = document.getElementById("dropLabel");
    label.innerHTML = `<span class="text-xl">‚úÖ</span><span>${filename}</span>`;
    setStatus(`Only the first ${LIMIT_SECONDS} seconds will be analyzed.`, "‚ÑπÔ∏è");
  }

  form.addEventListener("submit", async event => {
    event.preventDefault();
    const file = fileInput.files[0];
    if (!file) {
      setStatus("Please select a file.", "!");
      return;
    }

    processBtn.disabled = true;
    showLoader("Uploading clip‚Ä¶");
    setStatus("Uploading trimmed clip‚Ä¶", "‚Üë");
    resetDownloadCard();
    cancelPolling();

    const fd = new FormData();
    fd.append("file", file);

    try {
      const resp = await fetch(`${API_BASE}/jobs`, { method: "POST", body: fd });
      if (!resp.ok) {
        const detail = await resp.text();
        throw new Error(detail || `HTTP ${resp.status}`);
      }
      const data = await resp.json();
      if (!data.job_id) {
        throw new Error("Missing job id from backend");
      }

      showLoader(`Processing ${LIMIT_SECONDS} s clip‚Ä¶`);
      setStatus("Transcribing bassline‚Ä¶", "‚è≥");
      pollJob(data.job_id);
    } catch (err) {
      console.error(err);
      hideLoader();
      setStatus(`Error: ${err.message}`, "!");
      processBtn.disabled = false;
    }
  });

  variantSwitcher?.addEventListener("click", async event => {
    const btn = event.target.closest("[data-variant]");
    if (!btn) return;
    const variant = btn.dataset.variant;
    if (!availableDownloads[variant]) {
      return;
    }
    setActiveVariantButton(variant);
    try {
      await downloadSelectedVariant(lastJobId, variant);
    } catch (err) {
      console.error(err);
      setStatus(`Could not switch download: ${err.message}`, "!");
    }
  });

  function cancelPolling() {
    if (currentPollAbort) {
      currentPollAbort.abort();
      currentPollAbort = null;
    }
  }

  window.addEventListener("beforeunload", () => {
    if (currentDownloadUrl) {
      URL.revokeObjectURL(currentDownloadUrl);
    }
    cancelPolling();
  });
</script>

</body>
</html>
